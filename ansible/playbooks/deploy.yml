# Safety-First Orchestration Example
# This playbook demonstrates a safe, minimal pattern for scaling Jarvas-runner tasks across hosts.
# It uses a canary-first approach and requires human validation before full rollout.

- name: Canary deploy using jarvas_lite_run
  hosts: localhost
  connection: local
  gather_facts: no
  vars:
    canary_hosts: "canary1,canary2"
    full_hosts: "host1,host2,host3"
    run_dir: "{{ lookup('env','RUNS_DIR') | default('/var/lib/jarvas/runs', true) }}"
  tasks:
    - name: Run jarvas_lite_run for canary group
      shell: |
        set -euo pipefail
        RUN_ID="canary-$(date -u +%Y%m%dT%H%M%SZ)"
        /usr/bin/env bash ./tools/jarvas_lite_run.sh run --action system_health --run-id "$RUN_ID" --command "./skills/system_health/system_health.sh"
        echo "$?" > /tmp/canary_rc
      args:
        executable: /bin/bash
    - name: Read canary RC
      slurp:
        src: /tmp/canary_rc
      register: canary_rc
    - name: Fail if canary failed
      fail:
        msg: "Canary execution failed (non-zero return code). Aborting rollout."
      when: "(canary_rc.content | b64decode).strip() | int != 0"
    - name: Run jarvas_lite_run for full rollout
      shell: |
        set -euo pipefail
        RUN_ID="rollout-$(date -u +%Y%m%dT%H%M%SZ)"
        /usr/bin/env bash ./tools/jarvas_lite_run.sh run --action system_health --run-id "$RUN_ID" --command "./skills/system_health/system_health.sh"
      args:
        executable: /bin/bash
